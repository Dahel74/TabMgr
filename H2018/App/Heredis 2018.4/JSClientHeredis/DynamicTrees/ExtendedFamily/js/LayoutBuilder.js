function Node(object,level,options){this.key=Node.key++,object.nodeKey=this.key,this.codeId=object.codeId,this.move=0,this.level=level,void 0!==options&&Object.keys(options).forEach(function(key){this[key]=options[key]},this),this.addPosition=function(move){this.move+=move},this.getLocation=function(layoutParameters){return this.move+" "+this.level*(layoutParameters.layerSpace+layoutParameters.caseHeight)}}function objectToNodeKey(object){return object instanceof Node?object.key:object instanceof Individu?object.nodeKey:object instanceof Union?object.nodeKey:void 0}function Link(fromObject,toObject,options){this.from=objectToNodeKey(fromObject),this.to=objectToNodeKey(toObject),this.category=options.category,this.type=void 0===options.type?Link.Type.MINOR:options.type,this.fromPort=options.fromPort,this.toPort=options.toPort;var type;this.typeString=(type=this.type)===Link.Type.MAJOR?"major":type===Link.Type.MINOR?"minor":"indirect"}function Branch(){this.subBranches=[],this.nodes=[],this.move=0,this.rootNode=void 0,this.addRootNode=function(node){this.addNode(node),this.rootNode=node},this.linkRootTo=function(node,options){void 0!==this.rootNode?this.addLink(new Link(this.rootNode,node,options)):this.subBranches.forEach(function(subBranch){subBranch.linkRootTo(node,options)},this)},this.linkRootFrom=function(node,options){void 0!==this.rootNode?this.addLink(new Link(node,this.rootNode,options)):this.subBranches.forEach(function(subBranch){subBranch.linkRootFrom(node,options)},this)},this.links=[],this.addLink=function(link){this.links.push(link)},this.computeLinks=function(){var links=this.links;return this.subBranches.forEach(function(subBranch){links=links.concat(subBranch.computeLinks())},this),links},this.addNode=function(node){this.nodes.push(node)},this.addSubBranch=function(subBranch){this.subBranches.push(subBranch)},this.isEmpty=function(){return!(this.nodes.length>0)&&!this.subBranches.some(function(subBranch){return!subBranch.isEmpty()})},this.addPosition=function(move){this.move+=move},this.computePositions=function(){0!=this.move&&this.nodes.forEach(function(node){node.addPosition(this.move)},this);var nodes=this.nodes;return this.subBranches.forEach(function(subBranch){subBranch.addPosition(this.move);var subNodes=subBranch.computePositions();nodes=nodes.concat(subNodes)},this),this.move=0,nodes},this.getLeft=function(move,rangeLevel){move=void 0===move?0:move,move+=this.move;var min=this.nodes.reduce(function(previous,current){if(void 0!==rangeLevel&&(current.level<rangeLevel.min||rangeLevel.max<current.level))return previous;var currentMin=current.move+move;return void 0===previous?currentMin:void 0===currentMin?previous:Math.min(previous,currentMin)},void 0);return min=this.subBranches.reduce(function(previous,current){var currentMin=current.getLeft(move,rangeLevel);return void 0===previous?currentMin:void 0===currentMin?previous:Math.min(previous,currentMin)},min)},this.getLeftPositionOnLevels=function(rangeLevel){return this.getLeft(0,rangeLevel)},this.getRight=function(move,rangeLevel){move=void 0===move?0:move,move+=this.move;var max=this.nodes.reduce(function(previous,current){if(void 0!==rangeLevel&&(current.level<rangeLevel.min||rangeLevel.max<current.level))return previous;var currentMax=current.move+move;return isNaN(previous)?currentMax:isNaN(currentMax)?previous:Math.max(previous,currentMax)},NaN);return max=this.subBranches.reduce(function(previous,current){var currentMax=current.getRight(move,rangeLevel);return isNaN(previous)?currentMax:isNaN(currentMax)?previous:Math.max(previous,currentMax)},max)},this.getRightPositionOnLevels=function(rangeLevel){return this.getRight(0,rangeLevel)},this.getLenPosition=function(){var min=this.getLeft(),max=this.getRight();return isNaN(min)||isNaN(max)?NaN:max-min},this.getCenterPosition=function(){var min=this.getLeft();return min+(this.getRight()-min)/2},this.alignCenterOn=function(position){var center=this.getCenterPosition();if(!isNaN(center)){var move=position-center;this.addPosition(move)}},this.alignCenterWith=function(branch){var centerPosition=branch.getCenterPosition();isNaN(centerPosition)||this.alignCenterOn(centerPosition)},this.alignLeftOn=function(position,space){var currentLeft=this.getLeft();if(!isNaN(currentLeft)){var move=position-currentLeft;void 0!==space&&(move+=space),this.addPosition(move)}},this.alignLeftWith=function(branch,space){var branchRight=branch.getRight();isNaN(branchRight)||this.alignLeftOn(branchRight,space)},this.alignRightOn=function(position,space){var currentRight=this.getRight();if(!isNaN(currentRight)){var move=position-currentRight;void 0!==space&&(move-=space),this.addPosition(move)}},this.alignRightWith=function(branch,space){var branchLeft=branch.getLeft();isNaN(branchLeft)||this.alignRightOn(branchLeft,space)},this.getLevelRange=function(){var range=this.nodes.reduce(function(previous,current){return void 0===previous&&(previous={min:current.level,max:current.level}),previous.min=Math.min(previous.min,current.level),previous.max=Math.max(previous.max,current.level),previous},void 0);return range=this.subBranches.reduce(function(previous,current){var currentRange=current.getLevelRange();return void 0===previous&&(previous=currentRange),void 0===currentRange?previous:(previous.min=Math.min(previous.min,currentRange.min),previous.max=Math.max(previous.max,currentRange.max),previous)},range)},this.fitLeftWith=function(branch,space,minRightPos){var rangeLevel=this.getLevelRange(),position=branch.getRightPositionOnLevels(rangeLevel);void 0!==minRightPos&&position<minRightPos&&(position=minRightPos),this.alignLeftOn(position,space)},this.fitRightWith=function(branch,space,maxLeftPos){var rangeLevel=this.getLevelRange(),position=branch.getLeftPositionOnLevels(rangeLevel);void 0!==maxLeftPos&&position>maxLeftPos&&(position=maxLeftPos),this.alignRightOn(position,space)},this.hasNodeOnLevel=function(level){var isOnSamelevel=this.nodes.some(function(node){return node.level==level});return!!isOnSamelevel||(isOnSamelevel=this.subBranches.some(function(subBranch){return subBranch.hasNodeOnLevel(level)}))}}function LayoutBuilder(layoutParameters){this.getDataManager=function(){return mDataManager},this.setDataManager=function(dataManager){mDataManager=new DataManager(dataManager)};var mIsDebugMode=!1;this.setDebugMode=function(isDebugMode){mIsDebugMode=isDebugMode};var mIsPrintMode=!1;this.setPrintMode=function(isPrintMode){mIsPrintMode=isPrintMode},this.getPrintMode=function(){return mIsPrintMode};var mBranches=void 0,mLayoutParameters=layoutParameters,mLinkDataArray=[],mNodeDataArray=[],mFilters=[];this.setFilters=function(filters){mFilters=filters};var isFiltered=function(filterType){return mFilters.some(function(filter){return filter===filterType})},alignCenterBranches=function(leftBranches,rightBranches,withgroupSpace){var space=0;space+=mLayoutParameters.caseWidth/2,space+=mLayoutParameters.unionSpace/2,withgroupSpace&&(space+=mLayoutParameters.groupSpace/2),leftBranches.alignRightOn(0,space),rightBranches.alignLeftOn(0,space)},getUnionBranches=function(union,spouseBranchCallback,childFrom,withgroupSpace,positionCallBack){var branches=new Branch;if(void 0===union)return branches;var husbandBranches=spouseBranchCallback(union.getHusband(),union,childFrom,2*union.mainChildSosaPosition),wifeBranches=spouseBranchCallback(union.getWife(),union,childFrom,2*union.mainChildSosaPosition+1);return void 0===positionCallBack?function(leftBranches,rightBranches,withgroupSpace){var leftFar=leftBranches.getRight(),rightFar=rightBranches.getLeft();isNaN(leftFar)&&(leftFar=rightFar),isNaN(rightFar)&&(rightFar=leftFar);var move=Math.max(leftFar,-rightFar);isNaN(move)||(move+=mLayoutParameters.caseWidth/2,move+=mLayoutParameters.unionSpace/2,withgroupSpace&&(move+=mLayoutParameters.groupSpace/2),leftBranches.addPosition(-move),rightBranches.addPosition(move))}(husbandBranches,wifeBranches,withgroupSpace):positionCallBack(husbandBranches,wifeBranches,withgroupSpace),branches.addSubBranch(husbandBranches),branches.addSubBranch(wifeBranches),branches},getAscendantStepBranch=function(individu,mainUnion,isLeft,level,options){var stepBranches=new Branch,space=mLayoutParameters.caseWidth+mLayoutParameters.groupSpace;return individu.getUnions().forEach(function(union){if(union.codeId!==mainUnion.codeId){var stepBranch=new Branch,spouse=union.getSpouse(individu.codeId),unionNode=new Node(union,level,{ribbonColor:options.ribbonColor}),spouseBranch=getSpouseBranch(spouse,union,level,options);spouseBranch.addNode(unionNode),spouseBranch.addLink(new Link(union,individu,{category:"spouseLink",type:Link.Type.MINOR,toPort:isLeft?"LeftSpousePort":"RightSpousePort"})),stepBranch.addSubBranch(spouseBranch),stepBranch.alignLeftWith(stepBranches,space),stepBranches.addSubBranch(stepBranch)}},this),stepBranches},RIBBON_COLOR_FROM_SOSA_POSITION={4:"#5ABFE0",5:"#B35AE0",6:"#FEA366",7:"#FEFE66",8:"#5AE05A",9:"#5A92E0",10:"#705AE0",11:"#E85DAE",12:"#FE6666",13:"#FEC266",14:"#FEE066",15:"#CBEF60"},mAscendantStepBranches=[],getGreatGrandParentBranches=function(greatGrandParent,greatGrandParentUnion,grandParentFrom,sosaPosition){var branches=new Branch;if(void 0===greatGrandParent&&mIsPrintMode)return branches;void 0===greatGrandParent&&(greatGrandParent=mDataManager.getFakeIndividu(sosaPosition,greatGrandParentUnion.codeId,grandParentFrom.codeId));var ribbonColor=void 0;return greatGrandParent.countUnions()>1&&!isFiltered(LayoutBuilder.FilterType.STEPPARENTS)&&(ribbonColor=RIBBON_COLOR_FROM_SOSA_POSITION[sosaPosition]),branches.addNode(new Node(greatGrandParent,-3,{ribbonColor:ribbonColor,unionCodeIdFrom:greatGrandParentUnion.codeId,sosaPosition:sosaPosition})),branches.addLink(new Link(greatGrandParentUnion,greatGrandParent,{category:"spouseLink",type:Link.Type.MINOR,toPort:"BottomSpousePort"})),isFiltered(LayoutBuilder.FilterType.STEPPARENTS)||function(greatGrandParent,greatGrandParentUnion,sosaPosition){var isLeft=sosaPosition<=5,depthLevel=5;isFiltered(LayoutBuilder.FilterType.GRANDCHILDREN)&&depthLevel--;var stepGreatGrandParentsBranch=getAscendantStepBranch(greatGrandParent,greatGrandParentUnion,isLeft,-3,{depthLevel:depthLevel,ribbonColor:RIBBON_COLOR_FROM_SOSA_POSITION[sosaPosition],lastLevelChildOnly:!isFiltered(LayoutBuilder.FilterType.GRANDCHILDREN),noChildren:isFiltered(LayoutBuilder.FilterType.SIBLINGS)});mAscendantStepBranches[sosaPosition]=stepGreatGrandParentsBranch}(greatGrandParent,greatGrandParentUnion,sosaPosition),branches},mSiblings=[],getGrandParentBranches=function(grandParent,grandParentUnion,parentFrom,sosaPosition){var branches=new Branch;if(void 0===grandParent&&mIsPrintMode)return branches;void 0===grandParent&&(grandParent=mDataManager.getFakeIndividu(sosaPosition,grandParentUnion.codeId,parentFrom.codeId));var ribbonColor=void 0;if(grandParent.countUnions()>1&&!isFiltered(LayoutBuilder.FilterType.STEPPARENTS)&&(ribbonColor=RIBBON_COLOR_FROM_SOSA_POSITION[sosaPosition]),branches.addNode(new Node(grandParent,-2,{ribbonColor:ribbonColor,unionCodeIdFrom:grandParentUnion.codeId,sosaPosition:sosaPosition})),branches.addLink(new Link(grandParentUnion,grandParent,{category:"spouseLink",type:Link.Type.MINOR,toPort:"BottomSpousePort"})),isFiltered(LayoutBuilder.FilterType.STEPPARENTS)||function(grandParent,grandParentUnion,sosaPosition){var isLeft=sosaPosition<=5,depthLevel=4;isFiltered(LayoutBuilder.FilterType.GRANDCHILDREN)&&depthLevel--;var stepGrandParentsBranch=getAscendantStepBranch(grandParent,grandParentUnion,isLeft,-2,{depthLevel:depthLevel,ribbonColor:RIBBON_COLOR_FROM_SOSA_POSITION[sosaPosition],lastLevelChildOnly:!isFiltered(LayoutBuilder.FilterType.GRANDCHILDREN),noChildren:isFiltered(LayoutBuilder.FilterType.SIBLINGS)});mAscendantStepBranches[sosaPosition]=stepGrandParentsBranch}(grandParent,grandParentUnion,sosaPosition),isFiltered(LayoutBuilder.FilterType.GREATGRANDPARENTS))return branches;var greatGrandParentUnion=grandParent.getParentsUnion();if(void 0!==greatGrandParentUnion||!0===grandParent.isFake||mIsPrintMode||(greatGrandParentUnion=mDataManager.getFakeParentUnion(sosaPosition,grandParent.codeId)),void 0===greatGrandParentUnion)return branches;greatGrandParentUnion.mainChildSosaPosition=sosaPosition,branches.addNode(new Node(greatGrandParentUnion,-3,{type:"ascendency"})),branches.addLink(new Link(grandParent,greatGrandParentUnion,{category:"parentLink",type:Link.Type.MINOR}));var grandParentSiblings=function(greatGrandParentUnion,grandParent){return isFiltered(LayoutBuilder.FilterType.SIBLINGS)?new Branch:getUnionChildren(greatGrandParentUnion,-2,grandParent)}(greatGrandParentUnion,grandParent);grandParentSiblings.linkRootTo(greatGrandParentUnion,{category:"parentLink",type:Link.Type.MINOR});var grandParentSiblingsSpace=mLayoutParameters.siblingSpace+mLayoutParameters.caseWidth;6===sosaPosition?(grandParentSiblings.alignRightWith(branches,grandParentSiblingsSpace),branches.addSubBranch(grandParentSiblings)):5===sosaPosition?(grandParentSiblings.alignLeftWith(branches,grandParentSiblingsSpace),branches.addSubBranch(grandParentSiblings)):mSiblings[sosaPosition]=grandParentSiblings;var greatGrandParentsBranchesBranches=function(greatGrandParentUnion,grandParentFrom){return getUnionBranches(greatGrandParentUnion,getGreatGrandParentBranches,grandParentFrom,!1)}(greatGrandParentUnion,grandParent);return branches.addSubBranch(greatGrandParentsBranchesBranches),branches},mLeftStepParentsBranch=void 0,mRightStepParentsBranch=void 0,mLeftParentsSiblingsBranch=void 0,mRightParentsSiblingsBranch=void 0,getParentBranches=function(parent,parentUnion,centralFrom,sosaPosition){var isLeft=sosaPosition%2==0,branches=new Branch;if(void 0===parent&&mIsPrintMode)return branches;void 0===parent&&(parent=mDataManager.getFakeIndividu(sosaPosition,parentUnion.codeId,centralFrom.codeId)),branches.addNode(new Node(parent,-1,{unionCodeIdFrom:parentUnion.codeId,sosaPosition:sosaPosition})),branches.addLink(new Link(parentUnion,parent,{category:"spouseLink",type:Link.Type.MINOR,toPort:"BottomSpousePort"})),isFiltered(LayoutBuilder.FilterType.STEPPARENTS)||function(parent,centralParentUnion,isLeft){var depthLevel=3;isFiltered(LayoutBuilder.FilterType.GRANDCHILDREN)&&depthLevel--;var stepParentsBranch=getAscendantStepBranch(parent,centralParentUnion,isLeft,-1,{stepChildrenWithChildreen:!0,depthLevel:depthLevel,lastLevelChildOnly:!isFiltered(LayoutBuilder.FilterType.GRANDCHILDREN),noChildren:isFiltered(LayoutBuilder.FilterType.SIBLINGS)});isLeft?mLeftStepParentsBranch=stepParentsBranch:mRightStepParentsBranch=stepParentsBranch}(parent,parentUnion,isLeft);var grandParentUnion=parent.getParentsUnion();if(void 0!==grandParentUnion||!0===parent.isFake||mIsPrintMode||(grandParentUnion=mDataManager.getFakeParentUnion(sosaPosition,parent.codeId)),void 0===grandParentUnion)return branches;grandParentUnion.mainChildSosaPosition=sosaPosition,branches.addNode(new Node(grandParentUnion,-2,{type:"ascendency"})),branches.addLink(new Link(parent,grandParentUnion,{category:"parentLink",type:Link.Type.MINOR})),isFiltered(LayoutBuilder.FilterType.SIBLINGS)||function(grandParentUnion,parent,isLeft){if(!isFiltered(LayoutBuilder.FilterType.SIBLINGS)){var depthLevel=4;lastLevelChildOnly=!0,isFiltered(LayoutBuilder.FilterType.COUSINS)?(depthLevel=2,lastLevelChildOnly=!1):isFiltered(LayoutBuilder.FilterType.GRANDCHILDREN)&&(depthLevel--,lastLevelChildOnly=!1);var parentSiblings=getUnionChildrenWithSpouseAndChildreen(grandParentUnion,-1,parent,{depthLevel:depthLevel,lastLevelChildOnly:lastLevelChildOnly});parentSiblings.linkRootTo(grandParentUnion,{category:"parentLink",type:Link.Type.MINOR}),isLeft?mLeftParentsSiblingsBranch=parentSiblings:mRightParentsSiblingsBranch=parentSiblings}}(grandParentUnion,parent,isLeft);var grandParentbranches=getUnionBranches(grandParentUnion,getGrandParentBranches,parent,!0);return branches.addSubBranch(grandParentbranches),branches},getIndividu=function(individu,parentUnion,level){var branch=new Branch;return void 0===individu?branch:(branch.addRootNode(new Node(individu,level)),branch)},getUnionChildren=function(parentUnion,level,siblingToSkip){return getUnionChildrenBranches(parentUnion,level,getIndividu,siblingToSkip)},getIndividuWithSpouseAndChildreen=function(individu,parentUnion,level,options){void 0===options&&(options={}),void 0===options.depthLevel&&(options.depthLevel=1),void 0===options.stepChildrenWithChildreen&&(options.stepChildrenWithChildreen=!0),void 0===options.linkType&&(options.linkType=Link.Type.MINOR);var branches=new Branch;branches.addRootNode(new Node(individu,level));var unionsBranches=new Branch,branchSpousePosition=mLayoutParameters.caseWidth/2+mLayoutParameters.unionSpace+mLayoutParameters.caseWidth/2,isFirstSpouse=!0;return individu.getUnions().forEach(function(union){var unionNode=new Node(union,level,{type:"descendantUnion"}),spouse=union.getSpouse(individu.codeId),spouseBranch=getSpouseBranch(spouse,union,level,{stepChildrenWithChildreen:options.stepChildrenWithChildreen,lastLevelChildOnly:options.lastLevelChildOnly,depthLevel:options.depthLevel-1,isFirstSpouse:isFirstSpouse});spouseBranch.isEmpty()||(spouseBranch.addNode(unionNode),spouseBranch.addLink(new Link(union,individu,{category:"spouseLink",type:options.linkType,toPort:"RightSpousePort"}))),spouseBranch.addPosition(branchSpousePosition),spouseBranch.alignLeftWith(unionsBranches,mLayoutParameters.caseWidth+mLayoutParameters.unionSpace),unionsBranches.addSubBranch(spouseBranch),(isFirstSpouse=isFirstSpouse&&spouseBranch.isEmpty())||(branchSpousePosition=0)},this),branches.addSubBranch(unionsBranches),branches},getUnionChildrenWithSpouseAndChildreen=function(parentUnion,level,individuToSkip,options){return getUnionChildrenBranches(parentUnion,level,getIndividuWithSpouseAndChildreen,individuToSkip,options)},getUnionChildrenBranches=function(parentUnion,level,getChildCallback,childToSkip,options){var branches=new Branch;if(void 0===parentUnion)return branches;var childIdToSkip=0;return void 0!==childToSkip&&(childIdToSkip=childToSkip.codeId),parentUnion.getChildren().forEach(function(individu){if(individu.codeId!==childIdToSkip){var childBranch=getChildCallback(individu,parentUnion,level,options);childBranch.alignLeftWith(branches,mLayoutParameters.siblingSpace+mLayoutParameters.caseWidth),branches.addSubBranch(childBranch)}},this),branches},getSpouseBranch=function(spouse,mainUnion,level,options){var depthLevel=options.depthLevel||0,branches=new Branch;if(void 0===spouse&&(spouse=mDataManager.getFakeSpouse(mainUnion)),branches.addNode(new Node(spouse,level,{type:"descendantSpouse",unionCodeIdFrom:mainUnion.codeId,ribbonColor:options.ribbonColor})),branches.addLink(new Link(mainUnion,spouse,{category:"spouseLink",type:options.spouseLinkType,toPort:"topSpousePort"})),!0===options.noChildren)return branches;var subOptions=jQuery.extend({},options);subOptions.stepChildrenWithChildreen=!1;var childrenBranch=new Branch,stepChildrenBranch=new Branch;if(1===depthLevel&&options.lastLevelChildOnly?childrenBranch=getUnionChildren(mainUnion,level+1):depthLevel>0&&(childrenBranch=getUnionChildrenWithSpouseAndChildreen(mainUnion,level+1,0,subOptions)),void 0!==spouse&&!0===options.stepChildrenWithChildreen){var unionIdToSkip=mainUnion.codeId;spouse.getUnions().forEach(function(union){if(union.codeId!==unionIdToSkip){var unionChildrenBranch=getUnionChildrenWithSpouseAndChildreen(union,level+1,0,subOptions);unionChildrenBranch.alignLeftWith(stepChildrenBranch,mLayoutParameters.siblingSpace+mLayoutParameters.caseWidth),stepChildrenBranch.addSubBranch(unionChildrenBranch)}},this)}var allChildrenBranches=linkSpouseWithChildreen(spouse,mainUnion,1,childrenBranch,stepChildrenBranch,subOptions);return allChildrenBranches.isEmpty()&&!0===spouse.isFake?new Branch:(branches.addSubBranch(allChildrenBranches),branches)},linkSpouseWithChildreen=function(spouse,mainUnion,level,childrenBranch,stepChildrenBranch,options){var allChildrenBranches=new Branch,hasChildren=!childrenBranch.isEmpty(),hasStepChildren=!stepChildrenBranch.isEmpty(),linkTypes={childrenLinkType:Link.Type.MINOR,stepChildLinkType:Link.Type.MINOR},isFirstSpouse=!1;if(void 0!==options&&(void 0!==options.childrenLinkType&&(linkTypes.childrenLinkType=options.childrenLinkType),void 0!==options.stepChildLinkType&&(linkTypes.stepChildLinkType=options.stepChildLinkType),void 0!==options.isFirstSpouse&&(isFirstSpouse=options.isFirstSpouse)),void 0!==spouse&&hasChildren&&hasStepChildren)childrenBranch.alignRightOn(0,mLayoutParameters.caseWidth/2+mLayoutParameters.siblingSpace/2),stepChildrenBranch.alignLeftOn(0,mLayoutParameters.caseWidth/2+mLayoutParameters.siblingSpace/2),childrenBranch.linkRootFrom(spouse,{category:"parentLinkSpouse",type:linkTypes.childrenLinkType,fromPort:"botLeftSpousePort"}),stepChildrenBranch.linkRootFrom(spouse,{category:"parentLinkSpouse",type:linkTypes.stepChildLinkType,fromPort:"botRightSpousePort"}),allChildrenBranches.addSubBranch(childrenBranch),allChildrenBranches.addSubBranch(stepChildrenBranch);else{var linkFrom=spouse;void 0===linkFrom&&(linkFrom=mainUnion),childrenBranch.linkRootFrom(linkFrom,{category:"parentLinkSpouse",type:linkTypes.childrenLinkType}),stepChildrenBranch.linkRootFrom(linkFrom,{category:"parentLinkSpouse",type:linkTypes.stepChildLinkType}),allChildrenBranches.addSubBranch(childrenBranch),allChildrenBranches.addSubBranch(stepChildrenBranch);var childAlignement=0;allChildrenBranches.getLenPosition()>0&&hasChildren&&isFirstSpouse&&(childAlignement=-mLayoutParameters.unionSpace/2-mLayoutParameters.caseWidth/2),allChildrenBranches.alignCenterOn(childAlignement)}return allChildrenBranches},addCentralDescendencyBranches=function(central){var branches=new Branch,branchSpousePosition=mLayoutParameters.centralCaseWidth/2+mLayoutParameters.unionSpace+mLayoutParameters.caseWidth/2;central.getUnions().forEach(function(union){var unionNode=new Node(union,0),spouseBranch=function(spouse,mainUnion,isFirstSpouse){var depthLevel=2;return isFiltered(LayoutBuilder.FilterType.GRANDCHILDREN)&&depthLevel--,getSpouseBranch(spouse,mainUnion,0,{stepChildrenWithChildreen:!isFiltered(LayoutBuilder.FilterType.STEPCHILDREN),depthLevel:depthLevel,lastLevelChildOnly:!isFiltered(LayoutBuilder.FilterType.GRANDCHILDREN),isFirstSpouse:isFirstSpouse})}(union.getSpouse(central.codeId),union,!1);spouseBranch.isEmpty()||(spouseBranch.addNode(unionNode),spouseBranch.addLink(new Link(union,central,{category:"spouseLink",type:Link.Type.MINOR,toPort:"CentralSpousePort"}))),spouseBranch.addPosition(branchSpousePosition),spouseBranch.alignLeftWith(branches,mLayoutParameters.caseWidth+mLayoutParameters.unionSpace),branches.addSubBranch(spouseBranch),branchSpousePosition=0},this),mBranches.addSubBranch(branches)},addExternBranch=function(stachedBranches,sosaPosition){var stachedBranch=stachedBranches[sosaPosition];if(void 0!==stachedBranch){var space=mLayoutParameters.caseWidth+mLayoutParameters.groupSpace,minimalSpace=mLayoutParameters.centralCaseWidth/2;!function(sosaPosition){for(;sosaPosition>3;)sosaPosition=Math.floor(sosaPosition/2);return 2===sosaPosition}(sosaPosition)?stachedBranch.fitLeftWith(mBranches,space,minimalSpace):stachedBranch.fitRightWith(mBranches,space,-minimalSpace),mBranches.addSubBranch(stachedBranch)}};this.build=function(centralId,nodeDataArray,linkDataArray){mBranches=new Branch,mLeftParentsSiblingsBranch=new Branch,mRightParentsSiblingsBranch=new Branch,mLeftStepParentsBranch=new Branch,mRightStepParentsBranch=new Branch,mAscendantStepBranches=[],mSiblings=[],mNodeDataArray=nodeDataArray,mLinkDataArray=linkDataArray;var central=mDataManager.getIndividu(centralId,1);if(void 0!==central||!mIsPrintMode){void 0===central&&(central=mDataManager.getFakeIndividu(1)),mBranches.addNode(new Node(central,0)),addCentralDescendencyBranches(central);var space,parentsBranches,centralParentUnion=central.getParentsUnion();void 0!==centralParentUnion||!0===central.isFake||mIsPrintMode||(centralParentUnion=mDataManager.getFakeParentUnion(1,central.codeId)),void 0!==centralParentUnion&&(centralParentUnion.mainChildSosaPosition=1,mBranches.addNode(new Node(centralParentUnion,-1,{type:"ascendency"})),mBranches.addLink(new Link(central,centralParentUnion,{category:"parentLink",type:Link.Type.MINOR})),parentsBranches=getUnionBranches(centralParentUnion,getParentBranches,central,!0,alignCenterBranches),mBranches.addSubBranch(parentsBranches),function(centralParentUnion,central){var siblingsBranches=new Branch;if(isFiltered(LayoutBuilder.FilterType.SIBLINGS))return siblingsBranches;if(void 0===centralParentUnion)return siblingsBranches;var centralId=0;void 0!==central&&(centralId=central.codeId);var onLeft=!0,leftSiblingsBranches=new Branch,rightSiblingsBranches=new Branch,depthLevel=3;isFiltered(LayoutBuilder.FilterType.GRANDCHILDREN)&&depthLevel--,centralParentUnion.getChildren().forEach(function(child){if(child.codeId===centralId)onLeft=!1;else{var childBranches=getIndividuWithSpouseAndChildreen(child,0,0,{depthLevel:depthLevel,lastLevelChildOnly:!isFiltered(LayoutBuilder.FilterType.GRANDCHILDREN)});childBranches.linkRootTo(centralParentUnion,{category:"parentLink",type:Link.Type.MINOR}),onLeft?(childBranches.alignLeftWith(leftSiblingsBranches,mLayoutParameters.siblingSpace+mLayoutParameters.caseWidth),leftSiblingsBranches.addSubBranch(childBranches)):(childBranches.alignLeftWith(rightSiblingsBranches,mLayoutParameters.siblingSpace+mLayoutParameters.caseWidth),rightSiblingsBranches.addSubBranch(childBranches))}});var space=mLayoutParameters.caseWidth+mLayoutParameters.siblingSpace;leftSiblingsBranches.fitRightWith(mBranches,space,-mLayoutParameters.centralCaseWidth/2),rightSiblingsBranches.fitLeftWith(mBranches,space,mLayoutParameters.centralCaseWidth/2),siblingsBranches.addSubBranch(leftSiblingsBranches),siblingsBranches.addSubBranch(rightSiblingsBranches),mBranches.addSubBranch(siblingsBranches)}(centralParentUnion,central),space=mLayoutParameters.caseWidth+mLayoutParameters.siblingSpace,mLeftStepParentsBranch.fitRightWith(mBranches,space,-mLayoutParameters.centralCaseWidth/2),mBranches.addSubBranch(mLeftStepParentsBranch),mRightStepParentsBranch.fitLeftWith(mBranches,space,mLayoutParameters.centralCaseWidth/2),mBranches.addSubBranch(mRightStepParentsBranch),function(){var space=mLayoutParameters.caseWidth+mLayoutParameters.siblingSpace;mLeftParentsSiblingsBranch.fitRightWith(mBranches,space,-mLayoutParameters.centralCaseWidth/2),mBranches.addSubBranch(mLeftParentsSiblingsBranch),mRightParentsSiblingsBranch.fitLeftWith(mBranches,space,mLayoutParameters.centralCaseWidth/2),mBranches.addSubBranch(mRightParentsSiblingsBranch)}(),addExternBranch(mAscendantStepBranches,5),addExternBranch(mAscendantStepBranches,4),addExternBranch(mAscendantStepBranches,6),addExternBranch(mAscendantStepBranches,7),addExternBranch(mSiblings,4),addExternBranch(mSiblings,7),addExternBranch(mAscendantStepBranches,11),addExternBranch(mAscendantStepBranches,10),addExternBranch(mAscendantStepBranches,9),addExternBranch(mAscendantStepBranches,8),addExternBranch(mAscendantStepBranches,12),addExternBranch(mAscendantStepBranches,13),addExternBranch(mAscendantStepBranches,14),addExternBranch(mAscendantStepBranches,15)),function(nodes){nodes.forEach(function(nodeItem){var codeId=nodeItem.codeId,nodeApiData=mDataManager.getApiNodeObject(codeId);void 0===nodeApiData?mIsDebugMode&&mNodeDataArray.push({loc:nodeItem.getLocation(mLayoutParameters),category:"cross",label:nodeItem.debugLabel}):"union"===nodeApiData.type||"fakeUnion"===nodeApiData.type?mNodeDataArray.push({key:nodeItem.key,codeId:codeId,loc:nodeItem.getLocation(mLayoutParameters),category:"ascendency"===nodeItem.type?"unionAscendent":"union",type:nodeItem.type}):"individu"===nodeApiData.type?mNodeDataArray.push({key:nodeItem.key,codeId:codeId,titles:nodeApiData.titles.join(" - "),loc:nodeItem.getLocation(mLayoutParameters),category:"descendantSpouse"===nodeItem.type?"descendantSpouse":nodeApiData.isMain?"central":"classic",type:nodeItem.type,unionCodeIdFrom:nodeItem.unionCodeIdFrom,ribbonColor:nodeItem.ribbonColor,isAscendant:null!=nodeItem.sosaPosition}):"fakeIndividu"===nodeApiData.type&&mNodeDataArray.push({key:nodeItem.key,codeId:codeId,titles:nodeApiData.titles.join(" - "),loc:nodeItem.getLocation(mLayoutParameters),category:nodeApiData.category,ribbonColor:nodeItem.ribbonColor})},this),mIsDebugMode&&mNodeDataArray.push({loc:"0 0",category:"cross",label:"origin"})}(mBranches.computePositions()),function(links){links.forEach(function(link){mLinkDataArray.push(link)})}(mBranches.computeLinks())}}}Node.key=0,Link.Type={MAJOR:0,MINOR:1,INDIRECT:2},LayoutBuilder.FilterType={GREATGRANDPARENTS:"GreatGrandParents",SIBLINGS:"Siblings",GRANDCHILDREN:"GrandChildren",COUSINS:"Cousins",STEPPARENTS:"StepParents",STEPCHILDREN:"StepChildren"};