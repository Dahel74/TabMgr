function DiagramPrinter(aAjaxController,aDiagram,centralId){var mAjaxController=aAjaxController,mDiagram=aDiagram,mPrintScale=mDiagram.scale,mDiagramOriginalScale=mDiagram.scale,mSizeType=PREFERENCES.get("kPrefsMeasurementUnits"),mmToIn=function(value){return Number(value/25.4).toFixed(1)},mPaperWidth=0,mPaperHeigth=0,mImageWidth=0,mImageHeigth=0,updatePaperSize=function(){var width=mViewModel.get("width"),height=mViewModel.get("height");mPaperWidth="Centimeters"===mSizeType?mmToIn(10*width):width,mPaperHeigth="Centimeters"===mSizeType?mmToIn(10*height):height,mImageWidth=96*mPaperWidth*1,mImageHeigth=96*mPaperHeigth*1,mDiagram.nodeTemplateMap.set("paperPart",$m(go.Part,"Auto",{layerName:"Tool"},new go.Binding("location","loc",go.Point.parse),$m(go.Shape,{figure:"Rectangle",stroke:"orange",strokeWidth:2,fill:null,width:mImageWidth/mPrintScale,height:mImageHeigth/mPrintScale}),$m(go.TextBlock,{font:"100px sans-serif",alignment:go.Spot.TopLeft,alignmentFocus:go.Spot.TopLeft,margin:20,stroke:"green"},new go.Binding("text","pageNumber")))),generatePaperParts()};this.getmDiagramOriginalScale=function(){return mDiagramOriginalScale};var mCurrentPaperParts=[],generatePaperParts=function(){var savedPadding=mDiagram.padding;mDiagram.padding=0,mDiagram.findLayer("Tool").isTemporary=!0,mCurrentPaperParts.length>0&&(mDiagram.model.removeNodeDataCollection(mCurrentPaperParts),mCurrentPaperParts=[]);var db=mDiagram.computeBounds(),boundswidth=db.width,boundsheight=db.height,imgWidth=mImageWidth,imgHeight=mImageHeigth,p=db.position.copy();if(mShowPagePreview){for(var pageNumber=1,i=0;i<boundsheight;i+=imgHeight/mPrintScale-mOverlapMargin)for(var j=0;j<boundswidth;j+=imgWidth/mPrintScale-mOverlapMargin)mCurrentPaperParts.push({loc:p.x+j+" "+(p.y+i),pageNumber:pageNumber++,category:"paperPart"});mDiagram.model.addNodeDataCollection(mCurrentPaperParts)}mDiagram.findLayer("Tool").isTemporary=!1,mDiagram.padding=savedPadding,mDiagram.zoomToFit()};this.generateImages=function(){var imgDiv=document.getElementById("printImages");imgDiv.innerHTML="";var savedPadding=mDiagram.padding;mDiagram.padding=0,mDiagram.findLayer("Tool").isTemporary=!0,mDiagram.model.removeNodeDataCollection(mCurrentPaperParts);for(var db=mDiagram.computeBounds(),boundswidth=db.width,boundsheight=db.height,imgWidth=mImageWidth,imgHeight=mImageHeigth,p=db.position.copy(),i=0;i<boundsheight;i+=imgHeight/mPrintScale-mOverlapMargin)for(var j=0;j<boundswidth;j+=imgWidth/mPrintScale-mOverlapMargin){var svg=mDiagram.makeSvg({scale:mPrintScale,position:new go.Point(p.x+j,p.y+i),size:new go.Size(imgWidth,imgHeight)});imgDiv.appendChild(svg),imgDiv.appendChild(document.createElement("br"))}mDiagram.model.addNodeDataCollection(mCurrentPaperParts),mDiagram.findLayer("Tool").isTemporary=!1,mDiagram.padding=savedPadding};var mFileName;this.exportPDF=function(){var width=72*mPaperWidth,height=72*mPaperHeigth,doc=new PDFDocument({compress:!1,autoFirstPage:!1,size:[width,height]}),stream=doc.pipe(blobStream()),xPos=0*width/2,yPos=0*height/2;$("svg").each(function(index,element){doc.addPage(),doc.addSVG(element,xPos,yPos,{useCSS:!0,fontCallback:function(){return"MyFont"}})}),doc.end(),stream.on("finish",function(){!function(blob){var filename=mFileName,reader=new window.FileReader;reader.onloadend=function(){var data=reader.result;kendo.saveAs({proxyURL:mAjaxController.getBaseUrl()+"/libheredis/appServicesDown/download",dataURI:data,fileName:filename,forceProxy:!0})},reader.readAsDataURL(blob)}(stream.toBlob("application/pdf"))})},this.printToPdf=function(){this.generateImages(),this.exportPDF()};this.OnLayoutCompleted=function(centralKey){!function(centralKey){if(void 0===mFileName&&null!=centralKey){var centralNodeData=mDiagram.findNodeForKey(centralKey);null!==centralNodeData&&(mFileName=TRANSLATER.get("HNLOC_EXTENDEDFAMILY_PRINT_PREVIEW_EXPORT_PDF_TITLE"),mFileName+=" "+centralNodeData.data.noms+" "+centralNodeData.data.prenom)}}(centralKey),updatePaperSize()};var mViewModel,formatMap={A4:{width:210,height:297},A3:{width:297,height:420},A2:{width:420,height:594},A1:{width:594,height:841},A0:{width:841,height:1189},Letter:{width:216,height:279},Ledger:{width:432,height:279},Demy:{width:445,height:572},"Double Demy":{width:572,height:889},"Quad Demy":{width:889,height:1143}},changeFormatOrientation=function(){var formatValue=mViewModel.get("format"),orientationValue=mViewModel.get("orientation"),formatData=formatMap[formatValue];if(void 0!==formatData){var width=formatData.width,height=formatData.height;"Centimeters"===mSizeType?(width/=10,height/=10):(width=mmToIn(width),height=mmToIn(height)),mViewModel.set("width","portrait"===orientationValue?width:height),mViewModel.set("height","portrait"===orientationValue?height:width),updatePaperSize()}},changeSize=function(){var formatValue=mViewModel.get("format");if(void 0!==formatMap[formatValue]){var formatList=mViewModel.get("formatList"),lastFormat=formatList[formatList.length-1];void 0===formatMap[lastFormat]&&mViewModel.set("format",lastFormat)}updatePaperSize()};mShowPagePreview=!0;var togglePagePreview=function(){mShowPagePreview=!mShowPagePreview,$("#showPagePreviewButton").text(TRANSLATER.get(mShowPagePreview?"HNLOC_EXTENDEDFAMILY_PRINT_PREVIEW_ACTION_HIDE_PAGE_PREVIEW":"HNLOC_EXTENDEDFAMILY_PRINT_PREVIEW_ACTION_SHOW_PAGE_PREVIEW")),generatePaperParts()};mLinkZoneEnabled=!1,mOverlapMargin=0;var toggleLinkZone=function(){mLinkZoneEnabled=!mLinkZoneEnabled,$("#enableLinkZoneButton").text(TRANSLATER.get(mLinkZoneEnabled?"HNLOC_EXTENDEDFAMILY_PRINT_PREVIEW_ACTION_DISABLE_LINK_ZONE":"HNLOC_EXTENDEDFAMILY_PRINT_PREVIEW_ACTION_ENABLE_LINK_ZONE")),mLinkZoneEnabled?mOverlapMargin=.2*96/mPrintScale:mOverlapMargin=0,generatePaperParts()};!function(){var paperFormatDataSource=[],initialFormat=null,initialHeight=null,initialWidth=null;TRANSLATER.get("Centimeters"===mSizeType?"HNLOC_EXTENDEDFAMILY_PRINT_PREVIEW_PAPER_FORMATS_METERS_VALUES":"HNLOC_EXTENDEDFAMILY_PRINT_PREVIEW_PAPER_FORMATS_INCHES_VALUES").split(",").forEach(function(format){paperFormatDataSource.push({text:format,value:format});var formatSize=formatMap[format];void 0===formatSize?console.log("Unknown format: "+format):null===initialFormat&&(initialFormat=format,initialHeight="Centimeters"===mSizeType?formatSize.height/10:mmToIn(formatSize.height),initialWidth="Centimeters"===mSizeType?formatSize.width/10:mmToIn(formatSize.width))}),paperFormatDataSource.push({text:TRANSLATER.get("HNLOC_EXTENDEDFAMILY_PRINT_PREVIEW_PAPER_FORMATS_CUSTOM_VALUE"),value:"Custom"}),$("#showPagePreviewButton").kendoButton(),$("#showPagePreviewButton").text(TRANSLATER.get("HNLOC_EXTENDEDFAMILY_PRINT_PREVIEW_ACTION_HIDE_PAGE_PREVIEW")),$("#enableLinkZoneButton").kendoButton(),$("#enableLinkZoneButton").text(TRANSLATER.get("HNLOC_EXTENDEDFAMILY_PRINT_PREVIEW_ACTION_ENABLE_LINK_ZONE")),$("#exportPDFButton").kendoButton(),$("#exportPDFButton").text(TRANSLATER.get("HNLOC_EXTENDEDFAMILY_PRINT_PREVIEW_EXPORT_PDF")),mViewModel=kendo.observable({paperFormatLabel:TRANSLATER.get("HNLOC_EXTENDEDFAMILY_PRINT_PREVIEW_PAPER_FORMATS_LABEL"),paperOrientationLabel:TRANSLATER.get("HNLOC_EXTENDEDFAMILY_PRINT_PREVIEW_PAPER_ORIENTATION_LABEL"),paperOrientationPortraitLabel:TRANSLATER.get("HNLOC_EXTENDEDFAMILY_PRINT_PREVIEW_PAPER_ORIENTATION_PORTRAIT"),paperOrientationLandscapeLabel:TRANSLATER.get("HNLOC_EXTENDEDFAMILY_PRINT_PREVIEW_PAPER_ORIENTATION_LANDSCAPE"),paperWidthLabel:TRANSLATER.get("HNLOC_EXTENDEDFAMILY_PRINT_PREVIEW_PAPER_WIDTH_LABEL"),paperHeightLabel:TRANSLATER.get("HNLOC_EXTENDEDFAMILY_PRINT_PREVIEW_PAPER_HEIGHT_LABEL"),formatList:paperFormatDataSource,format:initialFormat,width:initialWidth,height:initialHeight,orientation:"portrait",changeFormatOrientation:changeFormatOrientation,changeSize:changeSize,togglePagePreview:togglePagePreview,toggleLinkZone:toggleLinkZone,exportPDF:exportPDF}),kendo.bind($("#rightPanel"),mViewModel),$("#paperFormat").data("kendoDropDownList").options.height=500;var sizeFormat="#.00 "+("Centimeters"===mSizeType?"cm":"in");$("#paperWidth").kendoNumericTextBox({format:sizeFormat}),$("#paperHeight").kendoNumericTextBox({format:sizeFormat}),$("#global").show(),kendo.fx($("#rightPanel")).slideIn("left").play()}()}PDFDocument.prototype.addSVG=function(svg,x,y,options){return SVGtoPDF(this,svg,x,y,options),this};